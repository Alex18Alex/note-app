{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>Прогнозирование задолженностей</h2>
        <p class="text-muted">Построение прогнозов динамики задолженностей на основе исторических данных</p>
        
        <!-- Панель управления -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Параметры прогнозирования</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <label for="forecastMonths" class="form-label">Период прогноза:</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="forecastMonths" value="6" min="3" max="12">
                            <span class="input-group-text">месяцев</span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label for="datasetSelect" class="form-label">Датасет для анализа:</label>
                        <select class="form-select" id="datasetSelect">
                            <option value="">Загрузка датасетов...</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button class="btn btn-primary" onclick="generateForecast()" id="forecastBtn">
                                <i class="fas fa-chart-line"></i> Построить прогноз
                            </button>
                            <button class="btn btn-outline-secondary" onclick="resetForecast()">
                                <i class="fas fa-redo"></i> Сброс
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Информация о модели -->
                <div id="modelInfo" class="mt-3" style="display: none;">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> Информация о модели</h6>
                        <div id="modelDetails"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- График прогноза -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">График прогноза задолженности</h5>
            </div>
            <div class="card-body">
                <div id="forecastChartContainer">
                    <div class="text-center py-5 text-muted" id="noDataMessage">
                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                        <p>Выберите параметры и нажмите "Построить прогноз" для отображения графика</p>
                    </div>
                    <canvas id="forecastChart" height="300" style="display: none;"></canvas>
                </div>
            </div>
        </div>

        <!-- Метрики точности -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Метрики точности прогноза</h5>
                    </div>
                    <div class="card-body">
                        <div id="accuracyMetrics" class="text-center py-4 text-muted">
                            Метрики будут отображены после построения прогноза
                        </div>
                        <div id="metricsContent" style="display: none;">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="border rounded p-3">
                                        <h5 id="maeValue" class="text-warning">-</h5>
                                        <small class="text-muted">MAE (Средняя абсолютная ошибка)</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="border rounded p-3">
                                        <h5 id="rmseValue" class="text-danger">-</h5>
                                        <small class="text-muted">RMSE (Среднеквадратичная ошибка)</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="border rounded p-3">
                                        <h5 id="r2Value" class="text-success">-</h5>
                                        <small class="text-muted">R² (Коэффициент детерминации)</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Интерпретация результатов</h5>
                    </div>
                    <div class="card-body">
                        <div id="interpretationContent">
                            <p class="text-muted">После построения прогноза здесь появится интерпретация результатов и рекомендации.</p>
                        </div>
                        <div id="forecastSummary" style="display: none;">
                            <h6>Ключевые выводы:</h6>
                            <ul class="list-unstyled" id="forecastInsights">
                                <!-- Инсайты будут заполнены динамически -->
                            </ul>
                            <div class="alert alert-warning mt-3">
                                <small>
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <strong>Внимание:</strong> Прогноз основан на исторических данных и может не учитывать внешние факторы.
                                    Рекомендуется регулярно обновлять данные и пересматривать прогнозы.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Детали прогноза -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Детали прогноза по месяцам</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="exportForecastData()">
                    <i class="fas fa-download"></i> Экспорт данных
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="forecastTable">
                        <thead class="table-light">
                            <tr>
                                <th>Период</th>
                                <th>Тип</th>
                                <th>Прогнозируемая задолженность</th>
                                <th>Доверительный интервал</th>
                                <th>Примечание</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Данные будут заполнены динамически -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let forecastChart = null;
    
    // Инициализация страницы
    document.addEventListener('DOMContentLoaded', function() {
        loadDatasets();
        
        // Установка текущего датасета из URL параметров
        const urlParams = new URLSearchParams(window.location.search);
        const datasetId = urlParams.get('dataset_id');
        if (datasetId) {
            setTimeout(() => {
                document.getElementById('datasetSelect').value = datasetId;
            }, 1000);
        }
    });

    // Загрузка списка датасетов
    async function loadDatasets() {
        try {
            const response = await fetch('/api/datasets');
            const datasets = await response.json();
            
            const select = document.getElementById('datasetSelect');
            select.innerHTML = '<option value="">Выберите датасет...</option>';
            
            datasets.forEach(dataset => {
                const option = document.createElement('option');
                option.value = dataset.id;
                option.textContent = `${dataset.name} (${new Date(dataset.upload_date).toLocaleDateString()})`;
                select.appendChild(option);
            });
            
        } catch (error) {
            console.error('Error loading datasets:', error);
        }
    }

    // Генерация прогноза
    async function generateForecast() {
        const datasetId = document.getElementById('datasetSelect').value;
        const months = document.getElementById('forecastMonths').value;
        
        if (!datasetId) {
            alert('Пожалуйста, выберите датасет для анализа');
            return;
        }
        
        const forecastBtn = document.getElementById('forecastBtn');
        forecastBtn.disabled = true;
        forecastBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Построение прогноза...';
        
        try {
            const formData = new FormData();
            formData.append('months', months);
            
            const response = await fetch(`/forecast?dataset_id=${datasetId}`, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.error) {
                throw new Error(result.error);
            }
            
            displayForecastResult(result);
            
        } catch (error) {
            alert('Ошибка при построении прогноза: ' + error.message);
        } finally {
            forecastBtn.disabled = false;
            forecastBtn.innerHTML = '<i class="fas fa-chart-line"></i> Построить прогноз';
        }
    }

    // Отображение результатов прогноза
    function displayForecastResult(data) {
        // Скрываем сообщение об отсутствии данных
        document.getElementById('noDataMessage').style.display = 'none';
        document.getElementById('forecastChart').style.display = 'block';
        
        // Создаем график
        createForecastChart(data);
        
        // Обновляем метрики точности
        updateAccuracyMetrics(data.accuracy_metrics);
        
        // Заполняем таблицу деталей
        updateForecastTable(data);
        
        // Показываем интерпретацию
        showInterpretation(data);
        
        // Показываем информацию о модели
        showModelInfo(data);
    }

    // Создание графика прогноза
    function createForecastChart(data) {
        const ctx = document.getElementById('forecastChart').getContext('2d');
        
        // Уничтожаем предыдущий график если существует
        if (forecastChart) {
            forecastChart.destroy();
        }
        
        const historicalLabels = data.historical.map(item => item.period);
        const historicalData = data.historical.map(item => item.debt);
        
        const forecastLabels = data.forecast.map(item => item.period);
        const forecastData = data.forecast.map(item => item.debt);
        
        const allLabels = [...historicalLabels, ...forecastLabels];
        const allData = [...historicalData, ...forecastData];
        
        forecastChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: allLabels,
                datasets: [
                    {
                        label: 'Исторические данные',
                        data: historicalData,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.1,
                        fill: false
                    },
                    {
                        label: 'Прогноз',
                        data: [...Array(historicalData.length).fill(null), ...forecastData],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        borderDash: [5, 5],
                        tension: 0.1,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Прогноз динамики задолженности'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    }

    // Обновление метрик точности
    function updateAccuracyMetrics(metrics) {
        document.getElementById('accuracyMetrics').style.display = 'none';
        document.getElementById('metricsContent').style.display = 'block';
        
        document.getElementById('maeValue').textContent = metrics.mae.toLocaleString();
        document.getElementById('rmseValue').textContent = metrics.rmse.toLocaleString();
        document.getElementById('r2Value').textContent = metrics.r_squared.toLocaleString();
    }

    // Обновление таблицы прогноза
    function updateForecastTable(data) {
        const tbody = document.querySelector('#forecastTable tbody');
        tbody.innerHTML = '';
        
        // Добавляем исторические данные
        data.historical.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.period}</td>
                <td><span class="badge bg-primary">История</span></td>
                <td>${formatCurrency(item.debt)}</td>
                <td>-</td>
                <td>Фактические данные</td>
            `;
            tbody.appendChild(row);
        });
        
        // Добавляем прогнозные данные
        data.forecast.forEach((item, index) => {
            const row = document.createElement('tr');
            row.className = 'table-warning';
            row.innerHTML = `
                <td><strong>${item.period}</strong></td>
                <td><span class="badge bg-warning">Прогноз</span></td>
                <td><strong>${formatCurrency(item.debt)}</strong></td>
                <td>± ${formatCurrency(item.debt * 0.1)}</td>
                <td>${index === 0 ? 'Ближайший прогноз' : 'Долгосрочный прогноз'}</td>
            `;
            tbody.appendChild(row);
        });
    }

    // Показ интерпретации результатов
    function showInterpretation(data) {
        document.getElementById('interpretationContent').style.display = 'none';
        document.getElementById('forecastSummary').style.display = 'block';
        
        const insightsList = document.getElementById('forecastInsights');
        insightsList.innerHTML = '';
        
        const lastHistorical = data.historical[data.historical.length - 1];
        const firstForecast = data.forecast[0];
        const lastForecast = data.forecast[data.forecast.length - 1];
        
        const growth = ((lastForecast.debt - lastHistorical.debt) / lastHistorical.debt * 100);
        
        const insights = [
            `Текущая задолженность: <strong>${formatCurrency(lastHistorical.debt)}</strong>`,
            `Прогноз на конец периода: <strong>${formatCurrency(lastForecast.debt)}</strong>`,
            `Ожидаемый рост: <strong class="${growth >= 0 ? 'text-danger' : 'text-success'}">${growth.toFixed(1)}%</strong>`,
            `Период прогноза: <strong>${data.forecast.length} месяцев</strong>`,
            `Модель: <strong>${data.model_info}</strong>`
        ];
        
        insights.forEach(insight => {
            const li = document.createElement('li');
            li.className = 'mb-2';
            li.innerHTML = `<i class="fas fa-chart-line text-primary me-2"></i>${insight}`;
            insightsList.appendChild(li);
        });
    }

    // Показ информации о модели
    function showModelInfo(data) {
        document.getElementById('modelInfo').style.display = 'block';
        document.getElementById('modelDetails').innerHTML = `
            <p><strong>Алгоритм:</strong> ${data.model_info}</p>
            <p><strong>Количество исторических периодов:</strong> ${data.historical.length}</p>
            <p><strong>Период прогноза:</strong> ${data.forecast_months} месяцев</p>
            <p><strong>Качество модели:</strong> 
                <span class="badge ${data.accuracy_metrics.r_squared > 0.8 ? 'bg-success' : data.accuracy_metrics.r_squared > 0.6 ? 'bg-warning' : 'bg-danger'}">
                    R² = ${data.accuracy_metrics.r_squared}
                </span>
            </p>
        `;
    }

    // Сброс прогноза
    function resetForecast() {
        document.getElementById('noDataMessage').style.display = 'block';
        document.getElementById('forecastChart').style.display = 'none';
        document.getElementById('modelInfo').style.display = 'none';
        document.getElementById('metricsContent').style.display = 'none';
        document.getElementById('forecastSummary').style.display = 'none';
        document.getElementById('interpretationContent').style.display = 'block';
        
        document.querySelector('#forecastTable tbody').innerHTML = '';
        
        if (forecastChart) {
            forecastChart.destroy();
            forecastChart = null;
        }
    }

    // Экспорт данных прогноза
    function exportForecastData() {
        alert('Функция экспорта данных будет реализована в следующей версии');
    }

    // Форматирование валюты
    function formatCurrency(amount) {
        return new Intl.NumberFormat('ru-RU', {
            style: 'currency',
            currency: 'RUB',
            minimumFractionDigits: 0
        }).format(amount);
    }
</script>
{% endblock %}