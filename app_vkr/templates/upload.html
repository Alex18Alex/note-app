{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>Загрузка данных о платежах</h2>
        <p class="text-muted">Загрузите файл с данными о начислениях и платежах за ЖКУ</p>
        
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Форма загрузки</h5>
            </div>
            <div class="card-body">
                <!-- Область для перетаскивания файлов -->
                <div class="upload-area" id="uploadArea">
                    <div class="text-center py-5">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                        <h4>Перетащите файл сюда или нажмите для выбора</h4>
                        <p class="text-muted">Поддерживаемые форматы: CSV, Excel (.xlsx)</p>
                        <button class="btn btn-primary btn-lg mt-3" onclick="document.getElementById('fileInput').click()">
                            Выбрать файл
                        </button>
                    </div>
                    <input type="file" id="fileInput" accept=".csv,.xlsx" style="display: none;">
                </div>

                <!-- Информация о требуемой структуре данных -->
                <div class="mt-4">
                    <h6>Требуемая структура данных:</h6>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Колонка</th>
                                    <th>Обязательная</th>
                                    <th>Описание</th>
                                    <th>Пример</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>account_id</code></td>
                                    <td><span class="badge bg-danger">Да</span></td>
                                    <td>Уникальный идентификатор лицевого счета</td>
                                    <td>ACC001, 12345</td>
                                </tr>
                                <tr>
                                    <td><code>period</code></td>
                                    <td><span class="badge bg-danger">Да</span></td>
                                    <td>Период в формате ГГГГ-ММ</td>
                                    <td>2024-01, 2024-02</td>
                                </tr>
                                <tr>
                                    <td><code>charge_amount</code></td>
                                    <td><span class="badge bg-danger">Да</span></td>
                                    <td>Сумма начисления</td>
                                    <td>1500.00, 2500.50</td>
                                </tr>
                                <tr>
                                    <td><code>payment_amount</code></td>
                                    <td><span class="badge bg-danger">Да</span></td>
                                    <td>Сумма оплаты</td>
                                    <td>1500.00, 1000.00</td>
                                </tr>
                                <tr>
                                    <td><code>service_type</code></td>
                                    <td><span class="badge bg-warning">Нет</span></td>
                                    <td>Тип услуги (автоматически заполнится если отсутствует)</td>
                                    <td>Отопление, Водоснабжение</td>
                                </tr>
                                <tr>
                                    <td><code>resident_name</code></td>
                                    <td><span class="badge bg-warning">Нет</span></td>
                                    <td>ФИО жильца</td>
                                    <td>Иванов И.И.</td>
                                </tr>
                                <tr>
                                    <td><code>address</code></td>
                                    <td><span class="badge bg-warning">Нет</span></td>
                                    <td>Адрес</td>
                                    <td>ул. Ленина, д.1, кв.1</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Превью данных -->
                <div class="mt-4" id="previewSection" style="display: none;">
                    <h6>Предварительный просмотр данных:</h6>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Будут загружены только первые 50 строк для предварительного просмотра
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered" id="previewTable">
                            <thead class="table-light">
                                <!-- Заголовки будут заполнены динамически -->
                            </thead>
                            <tbody>
                                <!-- Данные будут заполнены динамически -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-success" id="submitBtn" onclick="handleFileUpload()">
                            <i class="fas fa-save"></i> Сохранить в базу данных
                        </button>
                        <button class="btn btn-secondary" onclick="resetUploadForm()">
                            <i class="fas fa-times"></i> Отмена
                        </button>
                    </div>
                </div>

                <!-- Статус загрузки -->
                <div id="uploadStatus" class="mt-3"></div>
            </div>
        </div>

        <!-- История загрузок -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">История загрузок</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="uploadHistoryTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Название</th>
                                <th>Дата загрузки</th>
                                <th>Описание</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Данные будут заполнены динамически -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        setupFileUpload();
        loadUploadHistory();
    });

    // Загрузка истории загрузок
    async function loadUploadHistory() {
        try {
            const response = await fetch('/api/datasets');
            const datasets = await response.json();
            
            const tbody = document.querySelector('#uploadHistoryTable tbody');
            tbody.innerHTML = '';
            
            datasets.forEach(dataset => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dataset.id}</td>
                    <td>${dataset.name}</td>
                    <td>${new Date(dataset.upload_date).toLocaleString()}</td>
                    <td>${dataset.description || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadDataset(${dataset.id})">
                            <i class="fas fa-chart-bar"></i> Анализ
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
        } catch (error) {
            console.error('Error loading upload history:', error);
        }
    }

    // Загрузка конкретного датасета
    function loadDataset(datasetId) {
        window.location.href = `/analytics?dataset_id=${datasetId}`;
    }

    // Сброс формы загрузки
    function resetUploadForm() {
        document.getElementById('fileInput').value = '';
        document.getElementById('previewSection').style.display = 'none';
        document.getElementById('uploadStatus').innerHTML = '';
    }
</script>
{% endblock %}